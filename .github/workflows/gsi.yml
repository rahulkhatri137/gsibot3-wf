name: Hakalle
 
on:
  push:
  workflow_dispatch:

env:
  TYPE: build
  TZ: Asia/Kolkata
jobs:
  Hakalle:
    runs-on: ubuntu-20.04
    timeout-minutes: 525600

    steps:
       - name: Checkouts
         uses: actions/checkout@master
         
       - name: Initializing environment
         continue-on-error: true
         timeout-minutes: 10
         run: |
              sudo -E apt-get -qq update
              sudo -E apt-get -qq install bc build-essential zip curl libstdc++6 git wget python gcc clang libssl-dev rsync flex bison ccache expect aria2 unace unrar zip unzip p7zip-full p7zip-rar sharutils rar uudeview mpack arj cabextract file-roller device-tree-compiler liblzma-dev brotli liblz4-tool axel gawk aria2 detox cpio rename build-essential simg2img aria2 python3-pip tree
              rm -rf /usr/lib/jvm/adoptopenjdk-8-hotspot-amd64
              sudo apt-get purge --purge openjdk* -y
              git config --global user.name "${{ secrets.GHUSER }}"
              git config --global user.email "${{ secrets.GHMAIL }}"
                   
       - name: Setup Java
         run: |
              export ABC="$(pwd)"
              cd /usr; sudo mkdir -p oracle/java/ && cd oracle/java/
              sudo wget 'https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.0.0.2/graalvm-ce-java17-linux-amd64-22.0.0.2.tar.gz' -O graalvm-jdk17.tar.gz >> /dev/null 2>&1
              sudo tar -xzvf graalvm-jdk17.tar.gz >> /dev/null 2>&1 && sudo rm -f graalvm-jdk17.tar.gz
              export JAVA_HOME=/usr/oracle/java/graalvm-ce-java17-22.0.0.2
              export PATH=$PATH:$JAVA_HOME/bin
              sudo update-alternatives --install "/usr/bin/javac" "javac" "/usr/oracle/java/graalvm-ce-java17-22.0.0.2/bin/javac" 1
              sudo update-alternatives --install "/usr/bin/java" "java" "/usr/oracle/java/graalvm-ce-java17-22.0.0.2/bin/java" 1
              sudo update-alternatives --install "/usr/bin/gu" "gu" "/usr/oracle/java/graalvm-ce-java17-22.0.0.2/bin/gu" 1
              sudo dpkg --purge --force-depends ca-certificates-java
              sudo apt-get install ca-certificates-java -y
              cd ${ABC}

       - name: Build Bot
         run: |
              export JAVA_HOME=/usr/oracle/java/graalvm-ce-java17-22.0.0.2
              export PATH=$PATH:$JAVA_HOME/bin
              git clone -b main ${{ secrets.HAKA }} Bot; sudo chmod -R 777 Bot ; cd Bot
              ./gradlew shadowJar
              cd .. ; mv Bot/hakalle/build/libs/*.jar Bot.jar
              rm -rf Bot ; sudo -E apt-get -qq install openjdk-8-jdk
         
       - name: Add values
         timeout-minutes: 1
         run: |
              curl ${{ secrets.GIST }} | bash

       - name: Setup SGSIs Tools
         continue-on-error: true
         timeout-minutes: 20
         run: |
              git clone --recurse-submodules https://github.com/rahulkhatri137/SGSIs -b both SGSIs
              sudo chmod -R 0777 SGSIs
              cd SGSIs
              git clone --recurse-submodules https://github.com/rahulkhatri137/SGSIs -b main11 11
              git clone --recurse-submodules https://github.com/rahulkhatri137/SGSIs -b main 12
              sudo chmod -R 0777 ./
              sudo bash 12/setup.sh
         
       - name: Run Bot
         timeout-minutes: 330
         continue-on-error: true
         run: |
              sudo /usr/oracle/java/graalvm-ce-java17-22.0.0.2/bin/java -jar Bot.jar

       - name: Re-run workflow
         continue-on-error: true
         run: |
              git clone https://${{ secrets.GH_TOKEN }}@github.com/${GITHUB_REPOSITORY} loop ; cd loop
              git commit --allow-empty -m "[LOOP] Re-run"
              git push -f
